
####### DOCKER IMAGES
.debian-image:
  image: blockstream/gdk-debian-ci@sha256:dd6454c9a23b5f5dbc1fd5ea623f70a6786bb94b17677129bce196149f591c87
  tags: [ ga ]

.android-image:
  image: blockstream/gdk-android-builder@sha256:699b78e138824909c0ddb35ae395309e710581bae0b54368b192b719b39845c7
  tags: [ ga ]

.python-image:
  image: blockstream/gdk-python-builder@sha256:6d36bad9654c8edc513a1ab86511572ffd7247445df120946bf89e9a79e83b77
  tags: [ ga ]

.ubuntu-image:
  image: blockstream/gdk-ubuntu-builder@sha256:5a13d4a2dceb98c43e58594eb338ad2aef6b572231919a1039650e116b05f2b9
  tags: [ ga ]

.ubuntu-arm64-image:
  image: blockstream/gdk-ubuntu-builder@sha256:c12dd07e76c37a61986875965c73ce727dae8f99951c4b1ab84a7b2ca5e3b5f9
  tags: [ arm64_docker ]

.fedora-image:
  image: blockstream/gdk-fedora-builder@sha256:a7aef04937556128e6fb2d2928515bd51993b5df1992ea22a6dfa5957ae055d8
  tags: [ ga ]

.aws-lambda-image:
  image: blockstream/gdk-aws-lambda-builder@sha256:21e704de116c338df99d7a4e0673d58e74d4ec8de73f72300a9cc8c71e277ef3
  tags: [ ga ]


.py_release:
  variables:
    INSTALL_PATH: "gdk-python"
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    expire_in: 1 day
    when: on_success
    paths:
    - wheelhouse


.gcloud-publish:
  image: blockstream/gcloud-docker-tf:1.1.7
  tags:
    - ga
  stage: publish
  variables:
    GCLOUD_URL: "gs://green-gdk-builds"
  before_script:
    - subfolder=$CI_PROJECT_NAME-$CI_COMMIT_SHA
    - TMPF=$(mktemp) || exit 1
    - echo $GCLOUD_PUSH_KEY > $TMPF
    - export GOOGLE_APPLICATION_CREDENTIALS=$TMPF
    - gcloud auth activate-service-account --key-file=$TMPF
    - rm -f $TMPF


##### WARNING!!!!
    # $PREBUILT_SUBDIR is the folder for the DIY caching system we have in place in mac machines
    # BUILD_IDX is your life belt in case you messed the CI up during the prebuild phase and the PREBUILT_DIR folder
    # is left in an unconsistent state, just change the BUILD_IDX and you are good to go.
.osx_env:
  variables:
    BUILD_IDX: "0"
    GDK_KEEP_DOWNLOADS: "1"
    PYTHON_VERSION: "3.9"
  before_script:
    - idx=($(shasum tools/* cmake/profiles/* | shasum))
    - export PREBUILT_SUBDIR="prebuilt-${idx}-${BUILD_IDX}"
    - echo "prebuild subdir is ${PREBUILT_SUBDIR}"
    - mkdir -p $CI_BUILDS_DIR/downloads # Global shared download directory
    - ln -s $CI_BUILDS_DIR/downloads downloads
    - brew install llvm@17
    - export BREW_PREFIX=$( [[ $(uname -m) == "arm64" ]] && echo "/opt/homebrew" || echo "/usr/local" )
    - export LLVM_PATH="$BREW_PREFIX/opt/llvm@17"
    - export PATH="$LLVM_PATH/bin:$PATH"
    - export CC="$LLVM_PATH/bin/clang"
    - export CXX="$LLVM_PATH/bin/clang++"
    - export LDFLAGS="-L$LLVM_PATH/lib"
    - export CPPFLAGS="-I$LLVM_PATH/include"
    - export CMAKE_PREFIX_PATH="$LLVM_PATH"
